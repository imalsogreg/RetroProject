
PROGRAM:
    spikeavg

DESCRIPTION:
    Performs various operations on collections of spike waveforms such
    as waveform averaging, realtime audio spike playback, and template
    matching.
    Spikeavg computes average spike waveforms with std dev or sems
    by reading an index file extracted from a cluster tree.
    It can also output the individual spike waveforms listed in an index file.
    Spikeavg can also generate a list of spike timestamps (tfiles), in either
    ascii or binary format, from an index file.

AUTHOR:
    Written by Matthew Wilson
    ARL Division of Neural Systems, Memory, and Aging
    University of Arizona
    Tucson, AZ 85724
    wilson@nsma.arizona.edu

DATES:
    original 5/91
    program update 9/91
    documentation update 11/91

USAGE:
    spikeavg spikefile [-iall] [-i index] [-if indexfile] [-template file]
	[-tetrode] [-o file] [-stout spikefile] [-show] [-showtimes] [-binary] 
	[-showavg] [-noavg] [-tstart timestamp][-tend timestamp]
	[-hipass corr] [-lowpass corr] [-cov] [-higherthan threshold] 
	[-lowerthan threshold]
	[-play x/y] [-signal pid bin(msec)] [-warp timefactor]
	[-timech ch] [-samplerate Hz] [-v] [-align] [-std]

OPTIONS:
    Note that spaces between options and arguments are important.
    Order of the arguments is not important. All arguments and options
    must be placed on a single line (no carriage returns).

INPUT FILE OPTIONS:
    spikefile
	This is the name of the data file containing timestamped,stereotrode
	or tetrode spike waveform information.  This file can be created from 
	a Brainwave(tm) uff file using the 'uffextract' program.
	This is not optional and must be specified. Only one spikefile
	file can be specified on the command line. 

	DEFAULT: none. Required argument.
	
    -i index
    -if indexfile	
    -iall
	These options specify the subset of spikes from the spikefile that
	are to be processed. 

	The -i option allows a single spike to be specified based on the 
	spike number which is the ordinal index of the spike in the 
	spikefile (1st spike in the file has index 1, 2nd 2, etc.) regardless 
	of timestamp. The -i option can be specified multiple times in a 
	single command line to select more than a single spike.

	The -if option specifies an ascii file which contains a list of
	spike indices to be used to select the processed spikes.

	The -iall option selects all spikes in the spikefile.

	DEFAULT: none

    -tetrode
	specifies that the spike file contains tetrode rather than
	stereotrode spike waveform data.

	DEFAULT: false (sterotrode data)

    -template file
	This option specifies the name of an ascii data file containing a
	spike waveform template. Each line of the file contains a single
	amplitude value of the spike template waveform. For stereotrode
	templates there must be 32 or 64 values. For tetrodes, 32 or 128.
	If only 32 points are used in a template (the size of a spike waveform
	on a single channel) then that single channel template will be applied 
	to each of the channels, and the maximum correlation value 
	of those matches will be used.
	A line beginning with a '%' character is considered a comment
	and is ignored. 
	Points in the template can be masked such that the template
	match is not performed over the entire spike waveform. To
	indicate a template point to be masked in this way, precede the
	template value with the '@' character.
	Example:
	    %
	    % this is an example of a template file
	    %
	    -51
	    -20
	    10
	    .
	    .
	    % this region of the template will not be used in the
	    % matching process. Note that the numbers themselves are
	    % incidental and it is only the initial '@' character that
	    % is processed. The values are left in for reference
	    %
	    @20
	    @45
	    @67
	    .
	    .
	    .
	    % ending with 32, 64, or 128 points depending on the type
	    % of template match being performed

	Note, if template matching is selected then the output
	will consist of the list of correlation values of the spikes with
	the template.
	If the -show option is selected, the output will
	consist of a list of spike indices of those spikes
	which passed the template match criteria. Only the -show
	option will affect the output under template matching.

	DEFAULT: none



OUTPUT FILE OPTIONS:
    The output files generated by specifying these options 
    consist of either ascii spike waveform data which can be viewed 
    using the 'xplot' program or binary timestamp data which can
    be used in subsequent analyses.

    -o file
	specifies the file to which either ascii average waveform data,
	individual spike waveform data (see -show), or timestamp data 
	(see -showtimes) will be sent. 

	DEFAULT: output to stdout (the terminal).

    -stout spikefile
	Specifies the file to which timestamped spike records are to
	be written out to. Using this option, a new spikefile containing
	only the specified subset of spikes can be created.

	DEFAULT: none

    -binary
	When used in conjunction with the -showtimes option
	this option results in the output of binary formatted timestamp files.

	DEFAULT: false (ascii timestamps)

    -show
	Specifies that all the individual waveforms making up the selected
	subset are to be output in addition to the average waveform.
	If template matching is seleted then this option results in an
	output of the spike indices of spikes which passed the template
	match criteria.

	DEFAULT: false (only output average waveform)

    -showtimes
	Output timestamps rather than waveforms. See -binary option for
	the file format of this output.

	DEFAULT: false

    -showavg
	Output the average waveform for the spikes specified.

	DEFAULT: true

    -noavg
	Suppress output of the average waveform for the spikes specified.

	DEFAULT: false

    -timech channel
	Allows the selected spike waveforms on a single channel of a 
	stereotrode or tetrode to be output with the proper timestamp
	relationships. The resulting file, when viewed with 'xplot' will
	be the timeseries of analog spike waveforms seen on a single channel.

	DEFAULT: false

    -std
	specifies that the average waveform should be output with error bars
	representing 1 standard deviation of the mean rather than a single
	standard error of the mean.

	DEFAULT: false (output standard error of the mean)

DATA RANGE OPTIONS:
    -tstart timestamp
	ignore all spikes with timestamps less than this value.

	DEFAULT: 0

    -tend timestamp
	ignore all spikes with timestamps greater than this value.

	DEFAULT: end of spike data 
    
THRESHOLD OPTIONS:
    -higherthan threshold
	the peak amplitude of each spike waveform must be greater than 
	or equal to the specified threshold otherwise it is rejected.

	DEFAULT: none

    -lowerthan threshold
	the peak amplitude of each spike waveform must be lower than the
	specified threshold otherwise it is rejected.

	DEFAULT: none

TEMPLATE MATCH OPTIONS:
    These options affect the criteria used to select spike waveforms based 
    on correlations with the templates specified with the -template option.
    Template evaluation is performed by computing the correlation 
    coefficient based on the non-masked regions of the template (see 
    the -template option). This calculation is as follows:
	corr = (W dot T)/(magnitude W * magnitude T) 
    which is the correlation coefficient ranging from -1 to 1 where W
    is the spike waveform and T is the template.
    This calculation is affected by the -cov option.

    -hipass corr
	selects the lower correlation bound above which spikes will be
	selected and below which they will be rejected.

	DEFAULT: -1

    -lowpass corr
	selects the upper correlation bound below which spikes will be
	selected and above which they will be rejected.

	DEFAULT: 1

    -cov
	Specifies that covariance of the waveform relative to the template 
	should be computed rather than correlation. The computation is,
	therefore, changed from (W dot T)/(magnitude W * magnitude T) which is
	the correlation coefficient ranging from -1 to 1, to
	(W dot T)/(magnitude T * magnitude T) which has a value of 1
	for an identical match and has a value dependent on the magnitude
	of W otherwise. With the -cov option, low amplitude waveforms
	(relative to the template) can be rejected using a hipass value,
	and high amplitude waveforms can be rejected using a lowpass value.

	DEFAULT: false (compute correlation coefficient)

SPIKE PLAYBACK OPTIONS:
    Spikes can be played back through the audio port of the Sun Sparcstations.
    Additionally, the audio playback of spikes can be synchronized with
    the video display of position playback through the 'xview' program.

    -play x/y
	specifies that stereotrode spikes on either the x or y channel
	should be played back through the audio port. The digitized spike
	waveforms are fed directly through the 8 bit D/A converter at
	time intervals dictated by the spike timestamps.
	This option is not available for tetrode data.

	DEFAULT: false

    -warp timefactor
	By default, the spikes are played back at realtime speed. Specifying
	a warpfactor can alter the playback speed.

	DEFAULT: 1 (realtime)

    -signal pid bin
	This option allows synchronization of playback with an external
	process (typically an 'xview' (xy) display of position over time) by
	sending the signal SIGUSR1 to the process specified by the pid
	argument, at intervals specified by bin, where bin is the number
	of msec in spike time (not real time). The pid (process
	id of the external process can be obtained using the 'ps' command.
	The bin size should correspond with the bin size of the
	xview position file being replayed.

	DEFAULT: false

MISCELLANEOUS OPTIONS:
    -usage
	displays the list of available options.

    -version
	displays the version number of the program

    -v
	this option turns on verbose mode which will display more extensive
	status information during data processing.

	DEFAULT: not verbose

    -align
	align spike waveforms at the time of their peak value when computing 
	the average. Note that this does not affect template matching.

	DEFAULT: false

    -samplerate
	This specifies the sampling rate used to aquire the spike data.
	This is used to scale sampled waveforms and affects -play
	and -timech output. Note that this does not affect the intervals
	between spikes, which are determined using timestamp values,
	only the time between sample points within a spike for playback
	purposes.

	DEFAULT: 33000

NOTES:

EXAMPLES:

    To view the 10th spike waveform from the spike file 'sdata1'

	spikeavg sdata1 -noavg -i 10 -o waveform10 -v

    To view the average waveform associated with the spikes listed in
    index file 'cluster1'

	spikeavg sdata1 -if cluster1 -o avg1 -v

    To create a timestamp file 'tdata1' for all spikes listed in the index 
    file 'cluster1'

	spikeavg sdata1 -if cluster1 -showtimes -binary -o tdata1 -v

    To extract all spikes which have at least a 0.8 correlation with
    the spike template 'template1' into spike file 'sdata1.tpl' and place 
    the average waveform of the results in the file 'avg1'

	spikeavg sdata1 -iall -template template1 -o avg1 -stout sdata1.tpl 
	-hipass 0.8 -v

    To extract all spikes which have at best a 0.8 correlation with
    the spike template 'noise1' (noise rejection) into spike file 'clean1.tpl' 
    with no average waveform output

	spikeavg sdata1 -iall -template noise1 -noavg -stout clean1.tpl 
	-lopass 0.8 -v


